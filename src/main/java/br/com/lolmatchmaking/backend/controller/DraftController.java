package br.com.lolmatchmaking.backend.controller;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import br.com.lolmatchmaking.backend.service.DraftService;
import br.com.lolmatchmaking.backend.util.SummonerAuthUtil;
import jakarta.servlet.http.HttpServletRequest;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

@Slf4j
@RestController
@RequestMapping("/api")
@RequiredArgsConstructor
public class DraftController {
    // ‚ö†Ô∏è LEGADO: DraftService est√° sendo substitu√≠do por DraftFlowService
    @Deprecated(forRemoval = true)
    private final DraftService draftService;

    private final br.com.lolmatchmaking.backend.service.DraftFlowService draftFlowService;
    private static final String KEY_ERROR = "error";
    private static final String KEY_SUCCESS = "success";

    record ConfirmSyncRequest(Long matchId, String playerId, Integer actionIndex, String summonerName) {
    }

    /**
     * ‚ö†Ô∏è LEGADO - Endpoint antigo, use /match/draft-action ao inv√©s
     * 
     * @deprecated Use /match/draft-action
     */
    @Deprecated(forRemoval = true)
    @PostMapping("/draft/sync-confirm")
    public ResponseEntity<Map<String, Object>> confirmSync(
            @RequestBody ConfirmSyncRequest req,
            HttpServletRequest httpRequest) {
        try {
            // üîí Autentica√ß√£o via header
            String authenticatedSummoner = SummonerAuthUtil.getSummonerNameFromRequest(httpRequest);

            // üîç Valida√ß√£o de ownership (se summonerName for fornecido no body)
            if (req.summonerName() != null && !authenticatedSummoner.equalsIgnoreCase(req.summonerName())) {
                log.warn("‚ö†Ô∏è [{}] Tentativa de confirmar sync de outro jogador: {}",
                        authenticatedSummoner, req.summonerName());
                return ResponseEntity.status(HttpStatus.BAD_REQUEST)
                        .body(Map.of(KEY_ERROR, "Nome do invocador n√£o corresponde ao jogador autenticado"));
            }

            log.info("‚úÖ [{}] Confirmando sync: matchId={}, playerId={}, actionIndex={}",
                    authenticatedSummoner, req.matchId(), req.playerId(), req.actionIndex());

            if (req.matchId() == null || req.playerId() == null || req.actionIndex() == null) {
                log.warn("‚ö†Ô∏è [{}] Par√¢metros obrigat√≥rios ausentes", authenticatedSummoner);
                return ResponseEntity.badRequest().body(Map.of(KEY_ERROR, "Par√¢metros obrigat√≥rios ausentes"));
            }

            draftService.confirmSync(req.matchId(), req.playerId(), req.actionIndex());
            return ResponseEntity.ok(Map.of("ok", true));

        } catch (Exception e) {
            log.error("‚ùå Erro ao confirmar sync", e);
            return ResponseEntity.internalServerError()
                    .body(Map.of(KEY_ERROR, e.getMessage()));
        }
    }

    record ConfirmDraftRequest(Long matchId, String playerId, String summonerName) {
    }

    /**
     * ‚ö†Ô∏è LEGADO - Endpoint antigo, use /match/{matchId}/confirm-final-draft ao
     * inv√©s
     * 
     * @deprecated Use /match/{matchId}/confirm-final-draft
     */
    @Deprecated(forRemoval = true)
    @PostMapping("/match/confirm-draft")
    public ResponseEntity<Map<String, Object>> confirmDraft(
            @RequestBody ConfirmDraftRequest req,
            HttpServletRequest httpRequest) {
        try {
            // üîí Autentica√ß√£o via header
            String authenticatedSummoner = SummonerAuthUtil.getSummonerNameFromRequest(httpRequest);

            // üîç Valida√ß√£o de ownership (se summonerName for fornecido no body)
            if (req.summonerName() != null && !authenticatedSummoner.equalsIgnoreCase(req.summonerName())) {
                log.warn("‚ö†Ô∏è [{}] Tentativa de confirmar draft de outro jogador: {}",
                        authenticatedSummoner, req.summonerName());
                return ResponseEntity.status(HttpStatus.BAD_REQUEST)
                        .body(Map.of(KEY_ERROR, "Nome do invocador n√£o corresponde ao jogador autenticado"));
            }

            log.info("‚úÖ [{}] Confirmando draft: matchId={}, playerId={}",
                    authenticatedSummoner, req.matchId(), req.playerId());

            if (req.matchId() == null || req.playerId() == null) {
                log.warn("‚ö†Ô∏è [{}] matchId e playerId s√£o obrigat√≥rios", authenticatedSummoner);
                return ResponseEntity.badRequest().body(Map.of(KEY_ERROR, "matchId e playerId s√£o obrigat√≥rios"));
            }

            draftService.confirmDraft(req.matchId(), req.playerId());
            return ResponseEntity.ok(Map.of(KEY_SUCCESS, true));

        } catch (Exception e) {
            log.error("‚ùå Erro ao confirmar draft", e);
            return ResponseEntity.internalServerError()
                    .body(Map.of(KEY_ERROR, e.getMessage()));
        }
    }

    @GetMapping("/match/{matchId}/draft-session")
    public ResponseEntity<Map<String, Object>> getDraftSession(@PathVariable Long matchId) {
        Map<String, Object> snapshot = draftFlowService.snapshot(matchId);
        if (snapshot.containsKey("exists") && !Boolean.TRUE.equals(snapshot.get("exists"))) {
            return ResponseEntity.notFound().build();
        }
        return ResponseEntity.ok(snapshot);
    }

    /**
     * ‚ö†Ô∏è LEGADO - Endpoint antigo
     * 
     * @deprecated Status de confirma√ß√£o agora via WebSocket
     */
    @Deprecated(forRemoval = true)
    @GetMapping("/match/{matchId}/confirmation-status")
    public ResponseEntity<Map<String, Object>> confirmationStatus(@PathVariable Long matchId) {
        return ResponseEntity.ok(Map.of("confirmationData", draftService.confirmationStatus(matchId)));
    }

    record ChangePickRequest(Long matchId, String playerId, String championId, String summonerName) {
    }

    /**
     * ‚úÖ ATUALIZADO: Chama DraftFlowService diretamente
     */
    @PostMapping("/match/change-pick")
    public ResponseEntity<Map<String, Object>> changePick(
            @RequestBody ChangePickRequest req,
            HttpServletRequest httpRequest) {
        try {
            // üîí Autentica√ß√£o via header
            String authenticatedSummoner = SummonerAuthUtil.getSummonerNameFromRequest(httpRequest);

            // üîç Valida√ß√£o de ownership (se summonerName for fornecido no body)
            if (req.summonerName() != null && !authenticatedSummoner.equalsIgnoreCase(req.summonerName())) {
                log.warn("‚ö†Ô∏è [{}] Tentativa de alterar pick de outro jogador: {}",
                        authenticatedSummoner, req.summonerName());
                return ResponseEntity.status(HttpStatus.BAD_REQUEST)
                        .body(Map.of(KEY_ERROR, "Nome do invocador n√£o corresponde ao jogador autenticado"));
            }

            log.info("üîÑ [{}] Alterando pick: matchId={}, playerId={}, championId={}",
                    authenticatedSummoner, req.matchId(), req.playerId(), req.championId());

            if (req.matchId() == null || req.playerId() == null || req.championId() == null) {
                log.warn("‚ö†Ô∏è [{}] Requisi√ß√£o inv√°lida - campos obrigat√≥rios faltando", authenticatedSummoner);
                return ResponseEntity.badRequest()
                        .body(Map.of(KEY_ERROR, "matchId, playerId e championId s√£o obrigat√≥rios"));
            }

            // ‚úÖ MIGRADO: Chama DraftFlowService diretamente (n√£o mais DraftService)
            draftFlowService.changePick(req.matchId(), req.playerId(), req.championId());
            return ResponseEntity.ok(Map.of(KEY_SUCCESS, true));

        } catch (Exception e) {
            log.error("‚ùå Erro ao alterar pick", e);
            return ResponseEntity.internalServerError()
                    .body(Map.of(KEY_ERROR, e.getMessage()));
        }
    }

    // ‚úÖ ATUALIZADO: Endpoint para editar picks no modal de confirma√ß√£o
    record ChangePickPathRequest(String playerId, Integer championId, Boolean confirmed, String summonerName) {
    }

    /**
     * ‚úÖ ATUALIZADO: Chama DraftFlowService diretamente
     */
    @PostMapping("/draft/{matchId}/changePick")
    public ResponseEntity<Map<String, Object>> changePickPath(
            @PathVariable Long matchId,
            @RequestBody ChangePickPathRequest req,
            HttpServletRequest httpRequest) {
        try {
            // üîí Autentica√ß√£o via header
            String authenticatedSummoner = SummonerAuthUtil.getSummonerNameFromRequest(httpRequest);

            // üîç Valida√ß√£o de ownership (se summonerName for fornecido no body)
            if (req.summonerName() != null && !authenticatedSummoner.equalsIgnoreCase(req.summonerName())) {
                log.warn("‚ö†Ô∏è [{}] Tentativa de alterar pick de outro jogador: {}",
                        authenticatedSummoner, req.summonerName());
                return ResponseEntity.status(HttpStatus.BAD_REQUEST)
                        .body(Map.of(KEY_ERROR, "Nome do invocador n√£o corresponde ao jogador autenticado"));
            }

            log.info("üîÑ [{}] changePick chamado: matchId={}, playerId={}, championId={}",
                    authenticatedSummoner, matchId, req.playerId(), req.championId());

            if (req.playerId() == null || req.championId() == null) {
                log.warn("‚ö†Ô∏è [{}] Requisi√ß√£o inv√°lida - campos obrigat√≥rios faltando", authenticatedSummoner);
                return ResponseEntity.badRequest()
                        .body(Map.of(KEY_ERROR, "playerId e championId s√£o obrigat√≥rios"));
            }

            // ‚úÖ MIGRADO: Chama DraftFlowService diretamente (n√£o mais DraftService)
            draftFlowService.changePick(matchId, req.playerId(), String.valueOf(req.championId()));
            return ResponseEntity.ok(Map.of(KEY_SUCCESS, true));

        } catch (Exception e) {
            log.error("‚ùå Erro ao alterar pick", e);
            return ResponseEntity.internalServerError()
                    .body(Map.of(KEY_ERROR, e.getMessage()));
        }
    }

    // ‚úÖ CORRE√á√ÉO #1: Endpoint para processar a√ß√µes de draft (pick/ban)
    record DraftActionRequest(Long matchId, Integer actionIndex, String championId, String playerId, String action,
            String summonerName) {
    }

    @PostMapping("/match/draft-action")
    public ResponseEntity<Map<String, Object>> processDraftAction(
            @RequestBody DraftActionRequest req,
            HttpServletRequest httpRequest) {
        log.info("\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        log.info("‚ïë  üéØ [DraftController] REQUISI√á√ÉO RECEBIDA                     ‚ïë");
        log.info("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");

        try {
            // üîí Autentica√ß√£o via header
            String authenticatedSummoner = SummonerAuthUtil.getSummonerNameFromRequest(httpRequest);

            // üîç Valida√ß√£o de ownership (se summonerName for fornecido no body)
            if (req.summonerName() != null && !authenticatedSummoner.equalsIgnoreCase(req.summonerName())) {
                log.warn("‚ö†Ô∏è [{}] Tentativa de processar a√ß√£o de draft de outro jogador: {}",
                        authenticatedSummoner, req.summonerName());
                return ResponseEntity.status(HttpStatus.BAD_REQUEST)
                        .body(Map.of(KEY_ERROR, "Nome do invocador n√£o corresponde ao jogador autenticado"));
            }

            log.info("üì• [{}] POST /match/draft-action", authenticatedSummoner);
            log.info("üìã [{}] Match ID: {}", authenticatedSummoner, req.matchId());
            log.info("üìã [{}] Action Index: {}", authenticatedSummoner, req.actionIndex());
            log.info("üìã [{}] Champion ID: {}", authenticatedSummoner, req.championId());
            log.info("üìã [{}] Player ID: {}", authenticatedSummoner, req.playerId());
            log.info("üìã [{}] Action: {}", authenticatedSummoner, req.action());

            if (req.matchId() == null || req.actionIndex() == null || req.championId() == null
                    || req.playerId() == null) {
                log.warn("‚ö†Ô∏è [{}] Requisi√ß√£o inv√°lida - campos obrigat√≥rios faltando", authenticatedSummoner);
                log.info("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
                return ResponseEntity.badRequest().body(Map.of(
                        KEY_SUCCESS, false,
                        KEY_ERROR, "matchId, actionIndex, championId e playerId s√£o obrigat√≥rios"));
            }
            log.info("üîÑ [DraftController] Chamando DraftFlowService.processAction()...");

            // ‚úÖ Chamar DraftFlowService.processAction()
            boolean success = draftFlowService.processAction(
                    req.matchId(),
                    req.actionIndex(),
                    req.championId(),
                    req.playerId());

            if (success) {
                log.info("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
                log.info("‚ïë  ‚úÖ [DraftController] A√á√ÉO PROCESSADA COM SUCESSO             ‚ïë");
                log.info("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n");
                return ResponseEntity.ok(Map.of(KEY_SUCCESS, true));
            } else {
                log.warn("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
                log.warn("‚ïë  ‚ùå [DraftController] A√á√ÉO REJEITADA                          ‚ïë");
                log.warn("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
                log.warn("‚ö†Ô∏è Motivos poss√≠veis:");
                log.warn("   - Campe√£o j√° utilizado");
                log.warn("   - Jogador incorreto para esta a√ß√£o");
                log.warn("   - A√ß√£o fora de ordem");
                log.info("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
                return ResponseEntity.badRequest().body(Map.of(
                        KEY_SUCCESS, false,
                        KEY_ERROR, "A√ß√£o inv√°lida: campe√£o j√° utilizado, jogador errado ou fora de ordem"));
            }
        } catch (Exception e) {
            log.error("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
            log.error("‚ïë  üí• [DraftController] ERRO AO PROCESSAR                       ‚ïë");
            log.error("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
            log.error("‚ùå Exce√ß√£o: {}", e.getMessage(), e);
            log.info("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
            return ResponseEntity.status(500).body(Map.of(
                    KEY_SUCCESS, false,
                    KEY_ERROR, "Erro ao processar a√ß√£o: " + e.getMessage()));
        }
    }

    // ‚úÖ NOVO: Endpoint para confirma√ß√£o final individual (TODOS os 10 jogadores)
    record ConfirmFinalDraftRequest(String playerId, String summonerName) {
    }

    @PostMapping("/match/{matchId}/confirm-final-draft")
    public ResponseEntity<Map<String, Object>> confirmFinalDraft(
            @PathVariable Long matchId,
            @RequestBody ConfirmFinalDraftRequest req,
            HttpServletRequest httpRequest) {

        log.info("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        log.info("‚ïë  ‚úÖ [DraftController] CONFIRMA√á√ÉO FINAL RECEBIDA              ‚ïë");
        log.info("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");

        try {
            // üîí Autentica√ß√£o via header
            String authenticatedSummoner = SummonerAuthUtil.getSummonerNameFromRequest(httpRequest);

            // üîç Valida√ß√£o de ownership (se summonerName for fornecido no body)
            if (req.summonerName() != null && !authenticatedSummoner.equalsIgnoreCase(req.summonerName())) {
                log.warn("‚ö†Ô∏è [{}] Tentativa de confirmar draft final de outro jogador: {}",
                        authenticatedSummoner, req.summonerName());
                return ResponseEntity.status(HttpStatus.BAD_REQUEST)
                        .body(Map.of(KEY_ERROR, "Nome do invocador n√£o corresponde ao jogador autenticado"));
            }

            log.info("üì• [{}] POST /match/{}/confirm-final-draft", authenticatedSummoner, matchId);
            log.info("üë§ [{}] Player ID: {}", authenticatedSummoner, req.playerId());

            if (req.playerId() == null || req.playerId().trim().isEmpty()) {
                log.warn("‚ö†Ô∏è [{}] playerId n√£o fornecido", authenticatedSummoner);
                return ResponseEntity.badRequest().body(Map.of(
                        KEY_SUCCESS, false,
                        KEY_ERROR, "playerId √© obrigat√≥rio"));
            }

            // ‚úÖ Chamar DraftFlowService para registrar confirma√ß√£o individual
            Map<String, Object> result = draftFlowService.confirmFinalDraft(matchId, req.playerId());

            boolean allConfirmed = (boolean) result.getOrDefault("allConfirmed", false);
            int confirmedCount = (int) result.getOrDefault("confirmedCount", 0);
            int totalPlayers = (int) result.getOrDefault("totalPlayers", 10);

            log.info("‚úÖ [{}] Confirma√ß√£o registrada: {}/{} jogadores confirmaram",
                    authenticatedSummoner, confirmedCount, totalPlayers);

            if (allConfirmed) {
                log.info("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
                log.info("‚ïë  üéÆ [DraftController] TODOS CONFIRMARAM - INICIANDO JOGO      ‚ïë");
                log.info("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
            }

            return ResponseEntity.ok(Map.of(
                    KEY_SUCCESS, true,
                    "allConfirmed", allConfirmed,
                    "confirmedCount", confirmedCount,
                    "totalPlayers", totalPlayers,
                    "message", allConfirmed
                            ? "Todos confirmaram! Iniciando jogo..."
                            : String.format("Confirmado! Aguardando %d jogadores...", totalPlayers - confirmedCount)));

        } catch (Exception e) {
            log.error("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
            log.error("‚ïë  üí• [DraftController] ERRO AO CONFIRMAR                       ‚ïë");
            log.error("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
            log.error("‚ùå Exce√ß√£o: {}", e.getMessage(), e);
            return ResponseEntity.status(500).body(Map.of(
                    KEY_SUCCESS, false,
                    KEY_ERROR, "Erro ao confirmar: " + e.getMessage()));
        }
    }

    // ‚úÖ NOVO: Endpoint para cancelar partida em progresso
    @DeleteMapping("/match/{matchId}/cancel")
    public ResponseEntity<Map<String, Object>> cancelMatch(@PathVariable Long matchId) {
        log.info("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        log.info("‚ïë  ‚ùå [DraftController] CANCELANDO PARTIDA                      ‚ïë");
        log.info("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù");
        log.info("üéØ Match ID: {}", matchId);

        try {
            draftFlowService.cancelMatch(matchId);

            log.info("‚úÖ [DraftController] Partida cancelada com sucesso");
            return ResponseEntity.ok(Map.of(
                    KEY_SUCCESS, true,
                    "message", "Partida cancelada com sucesso"));

        } catch (Exception e) {
            log.error("‚ùå [DraftController] Erro ao cancelar partida: {}", e.getMessage(), e);
            return ResponseEntity.status(500).body(Map.of(
                    KEY_SUCCESS, false,
                    KEY_ERROR, "Erro ao cancelar partida: " + e.getMessage()));
        }
    }
}
